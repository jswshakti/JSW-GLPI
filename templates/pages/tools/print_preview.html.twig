{% import 'components/form/fields_macros.html.twig' as fields %}
{% import 'components/form/basic_inputs_macros.html.twig' as _inputs %}
{% import 'components/alerts_macros.html.twig' as alerts %}

{% if is_render == false %}
    <div class="hr-text mt-2 mb-5">
        <span style="font-size: 1.5em;" >{{ __('Select tabs to print') }}</span>
    </div>
    <form name="print_form"method="post" action="{{ call('PrintPreview::getFormUrl') }}">
        <input type="hidden" name="_glpi_csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="itemtype" value="{{ itemtype }}">
        <input type="hidden" name="items_id" value="{{ items_id }}">
        <div class="container">
            <div class="row">
                {% for key, tab in tabs %}
                    <div class="col-1 my-2 align-items-center text-end">
                        {{ _inputs.checkbox(key, key == itemtype ? 1 : 0, {'disabled': key == itemtype ? true : false}) }}
                    </div>
                    <div class="col-3 text-start my-2">
                        {{ tab|raw }}
                    </div>
                {% endfor %}
            </div>

            <div class="hr my-2"></div>
            <div class="row">
                <div class="col-8 my-2">
                </div>
                <div class="col-1 my-2 align-items-center text-end">
                        <input type="checkbox" class="form-check-input" name="select_all" onclick="selectAllCheckboxes(this.checked)"/>
                </div>
                <div class="col-3 text-start my-2">
                    <i class="ti ti-checks me-1"></i>
                    {{ __('All') }}
                </div>
            </div>
        </div>
        <div class="hr my-2"></div>
        <div class="container text-center">
            <input name="generate_preview" class="btn btn-primary mt-2" type="submit" value="{{ __('Generate preview') }}" />
        </div>
    </form>
    <script>
        function selectAllCheckboxes(isChecked) {
            var checkboxes = document.querySelector('form[name="print_form"]').querySelectorAll('input[type=checkbox]:not([disabled])');

            checkboxes.forEach(function(checkbox) {
                checkbox.checked = isChecked;
            });
        }
        $(document).ready(function() {
            var form = document.querySelector('form[action="/main/public/front/massiveaction.php"]');
            if (form) {
                var modalDialogs = form.querySelectorAll('.modal-dialog');
                modalDialogs.forEach(function(modalDialog) {
                    modalDialog.classList.add('modal-lg');
                });
                console.log(modalDialogs);
            }
        })
    </script>
{% else %}
    {% if has_preview == true %}
        <div class="preview-summary">
            <div class="row g-3 justify-content-evenly">
                <div class="card border-0 shadow-none">
                    <div class="card-header">
                        <h4 class="card-title ps-4">
                            <i class="ti ti-file-text me-1"></i>
                            {{ __('Print preview summary') }}
                        </h4>
                    </div>
                    <div class="card-body d-flex flex-wrap">
                        <div class="col-12 col-xxl-{{ item_has_pictures ? '9' : '12' }} flex-column">
                            <div class="d-flex flex-row flex-wrap flex-xl-nowrap">
                                <div class="row flex-row align-items-start flex-grow-1">
                                    <div class="row flex-row">
                                        {% set print_btn %}
                                            <button type="button" class="btn btn-primary" id="print-preview" onclick="window.print();">
                                                <i class="ti ti-printer me-1"></i>
                                                {{ __('Print preview') }}
                                            </button>
                                        {% endset %}
                                        {{ fields.htmlField('last_preview_date', last_preview_date|formatted_datetime(true), __('Last preview date')) }}
                                        {{ fields.htmlField(
                                            'print-preview',
                                            print_btn
                                        )}}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="preview">
            <div class="card my-0 border-start-0 border-end-0 border-bottom-0 shadow-none">
                <div class="card-header">
                    <h4 class="card-title ps-4">
                        <i class="{{ call(item.getType() ~ '::getIcon') }}"></i> &nbsp {{ call(item.getType() ~ '::getTypeName') }}
                    </h4>
                </div>
            </div>
            {% include 'generic_show_form.html.twig' %}
            {% for key, value in printable_tabs %}
                {% if value == 1 and call('class_exists',[key]) and key != options.itemtype %}
                    <div class="break"></div>
                    <div class="card my-0 border-0 shadow-none">
                        <div class="card-header">
                            <h4 class="card-title ps-4">

                                <i class="{{ call(key ~ '::getIcon') }}"></i> &nbsp {{ key == 'Item_Devices' ? 'Components' : call(key ~ '::getTypeName') }}
                            </h4>
                        </div>
                    </div>
                    {% do call(key ~ '::displayTabContentForItem',[item, 0]) %}
                {% endif %}
            {% endfor %}
        </div>
        <script type="text/javascript">
            $(document).ready(() => {
                var preview = document.querySelector('.preview');
                if (preview) {
                    preview.querySelectorAll('input').forEach(input => {
                        input.setAttribute('readonly', true);
                    });

                    var tables = preview.querySelectorAll('table, .table');

                    tables.forEach(function(table) {
                        Object.assign(table.style, {
                            width: '100%',
                            maxWidth: '100%',
                            boxSizing: 'border-box',
                            tableLayout: 'fixed',
                            overflowX: 'hidden'
                        });

                        table.querySelectorAll('td, a, span').forEach(function(child) {
                            Object.assign(child.style, {
                                whiteSpace: 'normal',
                                wordWrap: 'break-word',
                                overflowWrap: 'break-word'
                            });
                        });

                        table.querySelectorAll('tfoot, tr[class*="noHover"]').forEach(function(element) {
                            element.style.display = 'none';
                        });

                        var maxColumnCount = Array.from(table.querySelectorAll('tr')).reduce((max, row) => {
                            return Math.max(max, row.children.length);
                        }, 0);

                        if (maxColumnCount > 3) {
                            table.querySelectorAll('th').forEach(function(th) {
                                if (!th.hasAttribute('colspan') || th.getAttribute('colspan') < 3) {
                                    Object.assign(th.style, {
                                        writingMode: 'vertical-rl',
                                        transform: 'rotate(180deg)',
                                        whiteSpace: 'nowrap',
                                        verticalAlign: 'top'
                                    });
                                }
                            });
                        }

                        table.querySelectorAll('th').forEach(function(th) {
                            if (th.querySelector('input[type="checkbox"]') || th.querySelector('div input[type="checkbox"]')) {
                                th.remove();
                            }
                        });

                        table.querySelectorAll('td').forEach(function(td) {
                            if (td.querySelector('input[type="checkbox"]') || td.querySelector('div input[type="checkbox"]')) {
                                td.remove();
                            }
                        });
                    });

                    preview.querySelectorAll('label.col-xxl-5').forEach(function(label) {
                        label.classList.add('col-sm-3');
                        label.classList.replace('text-xxl-end', 'text-xxl-start');
                    });

                    preview.querySelectorAll('div.col-xxl-7').forEach(function(content) {
                        content.classList.add('col-sm-9');
                    });

                    preview.querySelectorAll('div.form-field.col-sm-6').forEach(function(formfield) {
                        formfield.classList.add('col-sm-12');
                    });
                }
            });
        </script>
    {% else %}
        {{ alerts.alert_warning(
            __('No preview generated for this item, please execute "Display to a printable view" action.')
        ) }}
    {% endif %}
{% endif %}